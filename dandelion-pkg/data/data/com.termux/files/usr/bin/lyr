#!/data/data/com.termux/files/usr/bin/bash

# ==========================================
# üé® 1. TABELA DE CORES E ESTILOS AVAN√áADOS
# ==========================================
C='\033[0;36m'   # Ciano
P='\033[0;35m'   # Roxo
B='\033[0;34m'   # Azul
Y='\033[1;33m'   # Amarelo
G='\033[0;32m'   # Verde
R='\033[0;31m'   # Vermelho
W='\033[1;37m'   # Branco Brilhante
DIM='\033[2m'    # Opaco/Escuro
BLINK='\033[5m'  # Piscante (Alerta de Seguran√ßa)
NC='\033[0m'     # Reset

# ==========================================
# üß∞ 2. M√ìDULO DE DETEC√á√ÉO DE HARDWARE (DANDELION)
# ==========================================
print_header() {
    
    echo -e "${P}‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ${NC}"
    echo -e "${P}‚îÇ ü§ñ DANDELION OS - ADVANCED EXPLORER      ‚îÇ${NC}"
    echo -e "${P}‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ${NC}"
    
    # Leitura direta do Kernel para Bateria (Ultra r√°pido)
    if [ -f /sys/class/power_supply/battery/capacity ]; then
        bat=$(cat /sys/class/power_supply/battery/capacity)
    else
        bat="N/A"
    fi

    # Uso de RAM
    ram=$(free -m | awk '/Mem:/ {print $3"MB/"$2"MB"}')
    
    # Carga da CPU (Load Average)
    cpu=$(uptime | awk -F'load average:' '{ print $2 }' | xargs | cut -d, -f1)

    echo -e "${C}  ‚ö° CPU: ${W}${cpu}${C} | üß† RAM: ${W}${ram}${C} | üîã BAT: ${W}${bat}%${NC}"
    echo -e "${DIM}  üìç Path: $(pwd)${NC}\n"
}

# ==========================================
# üõ°Ô∏è 3. M√ìDULO DE SEGURAN√áA E AUDITORIA
# ==========================================
get_security_warning() {
    local item="$1"
    # Pegar permiss√£o octal real (ex: 777, 644)
    local perm=$(stat -c "%a" "$item" 2>/dev/null)
    
    # Se for 777 (Leitura/Escrita/Execu√ß√£o para TODOS)
    if [[ "$perm" == "777" ]]; then
        echo -e "${BLINK}${R}[‚ö†Ô∏è 777]${NC}"
    else
        echo -e ""
    fi
}

# ==========================================
# üóÇÔ∏è 4. MEGA DICION√ÅRIO DE √çCONES (GOD MODE)
# ==========================================
get_icon() {
    local item="$1"
    local ext="${1##*.}"

    # Regra 1: Pastas sempre ganham prioridade
    if [ -d "$item" ]; then echo -e "${B}ÔÑï${NC}"; return; fi

    # Regra 2: O Grande Mapeamento de Extens√µes
    case "$ext" in
        # üåê Web Development
        html|htm)      echo -e "${R}Óú∂${NC}" ;;
        css)           echo -e "${B}Óùâ${NC}" ;;
        scss|sass)     echo -e "${P}ÓòÉ${NC}" ;;
        php)           echo -e "${P}Û∞åü${NC}" ;;
        vue)           echo -e "${G}Û∞°Ñ${NC}" ;;
        js|mjs|cjs)    echo -e "${Y}Óòå${NC}" ;;
        ts|tsx)        echo -e "${B}Óò®${NC}" ;;
        
        # üóÑÔ∏è Database
        sql)           echo -e "${C}ÔáÄ${NC}" ;;
        db|sqlite|db3) echo -e "${B}ÓúÜ${NC}" ;;
        mongo)         echo -e "${G}Óû§${NC}" ;;

        # ‚öôÔ∏è Configs e Ambiente
        yaml|yml)      echo -e "${R}Óòï${NC}" ;;
        toml|ini)      echo -e "${DIM}Óòï${NC}" ;;
        conf)          echo -e "${W}ÔÄì${NC}" ;;
        env)           echo -e "${Y}Ôë¢${NC}" ;;
        xml)           echo -e "${R}Û∞óÄ${NC}" ;;

        # üì± Android Pro & Kernel (Custom ROMs/Root)
        prop)          echo -e "${G}Óúé${NC}" ;;
        rc)            echo -e "${C}Û∞íì${NC}" ;;
        te|cil)        echo -e "${R}Û∞åÜ${NC}" ;; # Arquivos SELinux
        mk|bp)         echo -e "${B}Û∞èÜ${NC}" ;; # Makefiles do Android
        smali)         echo -e "${P}Û∞Üß${NC}" ;;

        # üíª Linguagens Core
        cpp|cc|cxx)    echo -e "${B}Óòù${NC}" ;;
        c)             echo -e "${B}Óòû${NC}" ;;
        h|hpp)         echo -e "${C}ÔÉΩ${NC}" ;;
        rs)            echo -e "${Y}ü¶Ä${NC}" ;;
        java|class)    echo -e "${R}Óú∏${NC}" ;;
        py|pyc)        echo -e "${B}Óúº${NC}" ;;

        # üì¶ Pacotes, Bin√°rios e Imagens
        so)            echo -e "${R}Û∞ÆÑ${NC}" ;;
        apk|dex|apkx)  echo -e "${G}Óúé${NC}" ;;
        img|cpio|elf)  echo -e "${R}Ôë≥${NC}" ;;
        zip|tar|gz|xz|7z) echo -e "${R}Ôêê${NC}" ;;
        json)          echo -e "${Y}Óòã${NC}" ;;
        sh|zsh|bash)   echo -e "${G}Û±ÜÉ${NC}" ;;
        md|txt|log)    echo -e "${W}ÔÖú${NC}" ;;

        # Fallback para execut√°veis e outros
        *) 
            if [ -x "$item" ]; then echo -e "${G}Û±ÜÉ${NC}"
            else echo -e "Û∞àî"
            fi
            ;;
    esac
}

# ==========================================
# üöÄ 5. MOTOR DE RENDERIZA√á√ÉO
# ==========================================
print_header

if [[ "$@" != *"-l"* ]]; then
    ls -1 --color=never "$@" | while read -r file; do
        [ -z "$file" ] && continue
        # Roda a verifica√ß√£o de seguran√ßa (777)
        sec_warn=$(get_security_warning "$file")
        echo -e " $(get_icon "$file")  $file $sec_warn"
    done
else
    ls "$@" --color=never | while read -r line; do
        if [[ "$line" == "total"* ]]; then
            echo -e "${Y}üìä $line${NC}\n"
            continue
        fi

        filename=$(echo "$line" | awk '{print $NF}')
        
        if [[ "$filename" == "." || "$filename" == ".." ]]; then
            icon="${P}Óóø${NC}"
            sec_warn=""
        else
            icon=$(get_icon "$filename")
            sec_warn=$(get_security_warning "$filename")
        fi

        details=$(echo "$line" | awk '{$NF=""; print $0}')
        
        if [[ "$line" == *"->"* ]]; then
            link_target=$(echo "$line" | awk '{print $NF}')
            link_name=$(echo "$line" | awk '{print $(NF-2)}')
            details=$(echo "$line" | awk '{$NF=""; $(NF-1)=""; $(NF-2)=""; print $0}')
            echo -e " $icon  ${DIM}${details}${NC}${C}${link_name}${NC} ${P}Û∞Åî${NC} ${DIM}${link_target}${NC} $sec_warn"
        else
            echo -e " $icon  ${DIM}${details}${NC}${W}${filename}${NC} $sec_warn"
        fi
    done
fi

echo -e "\n${C}‚ú® Total: $(ls -1A "$@" | wc -l) items${NC}"

